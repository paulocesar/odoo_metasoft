// Generated by CoffeeScript 1.9.0
(function() {
  var CrudDisplay, Metasoft, fieldSearch, fieldValidator, jsRoot, loadMoreHtml, _,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __hasProp = {}.hasOwnProperty;

  jsRoot = this;

  _ = jsRoot._, Metasoft = jsRoot.Metasoft;

  fieldValidator = Metasoft.fieldValidator, fieldSearch = Metasoft.fieldSearch;

  loadMoreHtml = function() {
    return "<tr style=\"border: 0px;\"><td style='background-color: white; border: 0px;'>\n    <button class='load-more btn btn-default'>Carregar Mais</button>\n</td></tr>";
  };

  CrudDisplay = (function(_super) {
    __extends(CrudDisplay, _super);

    function CrudDisplay(opts) {
      this.renderItemlist = __bind(this.renderItemlist, this);
      this.onClickRemove = __bind(this.onClickRemove, this);
      this.onClickSave = __bind(this.onClickSave, this);
      this.refreshList = __bind(this.refreshList, this);
      this.loadMore = __bind(this.loadMore, this);
      this.doSearch = __bind(this.doSearch, this);
      if (this.tpls == null) {
        this.tpls = {};
      }
      if (this.events == null) {
        this.events = {};
      }
      if (this.withEmpresa == null) {
        this.withEmpresa = true;
      }
      if (this.limit == null) {
        this.limit = 100;
      }
      _.defaults(this.events, {
        'click .crud-list tr': 'onClickItemList',
        'click .save': 'onClickSave',
        'click .new': 'onClickReset',
        'click .remove': 'onClickRemove',
        'click .load-more': 'loadMore'
      });
      this.crudItems = [];
      CrudDisplay.__super__.constructor.apply(this, arguments);
      _.defaults(this.tpls, {
        crudList: _.template($("#tpl-display-" + this.name + "ListItem").html())
      });
      this.search = fieldSearch({
        el: "#display-" + this.name + " .crud-search",
        model: 'crud',
        action: 'search'
      });
      this.search.setOptions({
        table: this.table,
        withEmpresa: this.withEmpresa,
        limit: this.limit
      });
      this.search.on('search:done', this.renderItemlist);
      this.form = this.$('.form-crud');
    }

    CrudDisplay.prototype.doSearch = function() {
      this.search.setOptions({
        offset: this.offset
      });
      return this.search.doSearch();
    };

    CrudDisplay.prototype.loadMore = function() {
      this.offset += this.limit;
      return this.doSearch();
    };

    CrudDisplay.prototype.onShow = function() {
      return this.refreshList();
    };

    CrudDisplay.prototype.refreshList = function() {
      this.$('.query').val('');
      this.offset = 0;
      return this.doSearch();
    };

    CrudDisplay.prototype.isValid = function() {
      return true;
    };

    CrudDisplay.prototype.onClickReset = function() {
      return this.resetForm();
    };

    CrudDisplay.prototype.resetForm = function() {
      fieldValidator.reset(this.form);
      this.id = null;
      return this.updateButtonsDom();
    };

    CrudDisplay.prototype.onClickSave = function() {
      var data, valid;
      valid = fieldValidator.isValidAndUnique(this.form, this.crudItems, this.id, true);
      if (!(valid && this.isValid())) {
        return;
      }
      data = fieldValidator.getValues(this.form);
      if (this.id != null) {
        data.id = this.id;
      }
      return this.post('crud/upsert', {
        table: this.table,
        withEmpresa: this.withEmpresa,
        data: data
      }, (function(_this) {
        return function() {
          _this.refreshList();
          if (_this.refreshStaticData) {
            return Metasoft.refreshStaticData();
          }
        };
      })(this));
    };

    CrudDisplay.prototype.onClickRemove = function() {
      return this.post('crud/remove', {
        table: this.table,
        data: {
          id: this.id
        }
      }, (function(_this) {
        return function(res) {
          var field;
          if (res.related) {
            alert('Este item não pode ser removido pois está sendo usado');
          } else {
            field = _this.table + "ById";
          }
          _this.refreshList();
          if (_this.refreshStaticData) {
            return Metasoft.refreshStaticData();
          }
        };
      })(this));
    };

    CrudDisplay.prototype.renderItemlist = function(list) {
      var $l, hasMore;
      if (!this.offset) {
        this.crudItems = [];
      }
      hasMore = false;
      if (list) {
        this.crudItems = this.crudItems.concat(list);
        hasMore = list.length >= this.limit;
      }
      $l = this.$('.crud-list');
      $l.html(this.tpls.crudList({
        items: this.crudItems
      }));
      if (hasMore) {
        $l.append(loadMoreHtml());
      }
      return this.resetForm();
    };

    CrudDisplay.prototype.onClickItemList = function(ev) {
      var id;
      id = $(ev.currentTarget).data('rowid');
      return this.showItemInForm(id);
    };

    CrudDisplay.prototype.showItemInForm = function(_at_id) {
      var account;
      this.id = _at_id;
      account = _.findWhere(this.crudItems, {
        id: this.id
      });
      fieldValidator.fill(this.form, account);
      return this.updateButtonsDom();
    };

    CrudDisplay.prototype.updateButtonsDom = function() {
      this.$('.new').toggleClass('hidden', this.id == null);
      return this.$('.remove').toggleClass('hidden', this.id == null);
    };

    return CrudDisplay;

  })(Metasoft.Display);

  Metasoft.CrudDisplay = CrudDisplay;

}).call(this);
