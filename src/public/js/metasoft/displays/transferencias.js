// Generated by CoffeeScript 1.9.0
(function() {
  var DateNavigator, Metasoft, TransferenciaModal, Transferencias, fieldSearch, fieldValidator, jsRoot, moment, _,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __hasProp = {}.hasOwnProperty,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  jsRoot = this;

  _ = jsRoot._, Metasoft = jsRoot.Metasoft, moment = jsRoot.moment;

  fieldValidator = Metasoft.fieldValidator, fieldSearch = Metasoft.fieldSearch, DateNavigator = Metasoft.DateNavigator;

  TransferenciaModal = (function(_super) {
    __extends(TransferenciaModal, _super);

    function TransferenciaModal(opts) {
      this.el = '#modalTransferencia';
      this.events = {
        'click .save': 'onClickSave'
      };
      TransferenciaModal.__super__.constructor.apply(this, arguments);
      this.tplTransfModal = _.template($('#tpl-transferencia-crud').html());
      this.render();
    }

    TransferenciaModal.prototype.onClickSave = function() {
      return alert('funcionalidade em desenvolvimento');
    };

    TransferenciaModal.prototype.render = function() {
      var contas;
      contas = Metasoft.contaBancariaById;
      this.$('.modal-body').html(this.tplTransfModal({
        contas: contas
      }));
      return fieldValidator.apply(this.$el);
    };

    return TransferenciaModal;

  })(Metasoft.DisplayModal);

  Transferencias = (function(_super) {
    __extends(Transferencias, _super);

    function Transferencias(opts) {
      this.renderAccounts = __bind(this.renderAccounts, this);
      this.renderTransferencias = __bind(this.renderTransferencias, this);
      this.doSearch = __bind(this.doSearch, this);
      this.onShow = __bind(this.onShow, this);
      this.doSearch = __bind(this.doSearch, this);
      this.model = 'transferencia';
      this.events = {
        'click tr.conta': 'onClickConta',
        'change #transfereciaSearchForm .periodo': 'onChangePeriodo'
      };
      Transferencias.__super__.constructor.apply(this, arguments);
      this.tplAcctounts = _.template($('#tpl-transferencia-contas').html());
      this.tplTransf = _.template($('#tpl-transferencia-listItem').html());
      this.search = fieldSearch({
        el: '#transfereciaSearchForm',
        model: this.model,
        action: 'list'
      });
      this.search.on('search:done', this.renderTransferencias);
      this.dateNavigator = new DateNavigator({
        el: '#transfereciaSearchForm .date-navigator',
        period: 'dia'
      });
      this.dateNavigator.on('date:change', this.doSearch);
      this.transferenciaModal = new TransferenciaModal();
      this.reset();
    }

    Transferencias.prototype.onChangePeriodo = function() {
      var $periodField, period;
      $periodField = this.$('#transfereciaSearchForm .periodo');
      period = $periodField.val();
      if (period !== this.dateNavigator.period) {
        this.dateNavigator.setPeriod(period);
        return this.doSearch();
      }
    };

    Transferencias.prototype.doSearch = function() {
      return this.search.doSearch();
    };

    Transferencias.prototype.onShow = function() {
      var data;
      data = {
        table: 'contaBancaria',
        withEmpresa: true
      };
      return this.post('crud/list', data, (function(_this) {
        return function(contas) {
          _this.renderAccounts(contas);
          _this.setSelectedAccount(contas[0].id);
          return _this.doSearch();
        };
      })(this));
    };

    Transferencias.prototype.onClickConta = function(ev) {
      var contaBancariaId;
      contaBancariaId = $(ev.currentTarget).data('rowid');
      return this.setSelectedAccount(contaBancariaId);
    };

    Transferencias.prototype.doSearch = function() {
      return this.search.doSearch();
    };

    Transferencias.prototype.renderTransferencias = function(transferencias) {
      return this.$('.list-transferencias').html(this.tplTransf({
        contaBancariaId: this.contaBancariaId,
        transferencias: transferencias
      }));
    };

    Transferencias.prototype.renderAccounts = function(contas) {
      return this.$('.list-transferencia-contas').html(this.tplAcctounts({
        contas: contas
      }));
    };

    Transferencias.prototype.reset = function() {
      return fieldValidator.fill(this.$('#transfereciaSearchForm'), {
        query: '',
        periodo: 'dia',
        data: moment().format('YYYY-MM-DD 00:00:00')
      });
    };

    Transferencias.prototype.setSelectedAccount = function(_at_contaBancariaId) {
      this.contaBancariaId = _at_contaBancariaId;
      return this.search.setOptions({
        contaBancariaId: this.contaBancariaId
      });
    };

    return Transferencias;

  })(Metasoft.Display);

  Metasoft.displays.Transferencias = Transferencias;

}).call(this);
